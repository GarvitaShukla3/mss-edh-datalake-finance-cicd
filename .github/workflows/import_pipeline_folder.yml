name: Deploy Microsoft Fabric Pipelines via Git Sync

on:
  workflow_dispatch:

env:
  CLIENT_ID: ${{ secrets.CLIENT_ID }}
  TENANT_ID: ${{ secrets.TENANT_ID }}
  CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
  FABRIC_WORKSPACE_ID: ${{ secrets.FABRIC_WORKSPACE_ID }}
  GITHUB_REPOSITORY: mss-edh-datalake-finance-cicd
  GITHUB_REF: deploy/pipeline

jobs:
  deploy-pipelines:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history to get commit SHA

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Get Azure AD access token
        id: get_token
        run: |
          echo "üîê Requesting access token..."
          RESPONSE=$(curl -s -X POST -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=client_credentials" \
            -d "client_id=${{ env.CLIENT_ID }}" \
            -d "client_secret=${{ env.CLIENT_SECRET }}" \
            -d "scope=https://analysis.windows.net/powerbi/api/.default" \
            "https://login.microsoftonline.com/${{ env.TENANT_ID }}/oauth2/v2.0/token")

          ACCESS_TOKEN=$(echo "$RESPONSE" | jq -r '.access_token')

          if [ -z "$ACCESS_TOKEN" ] || [ "$ACCESS_TOKEN" == "null" ]; then
            echo "‚ùå Failed to retrieve access token."
            echo "$RESPONSE"
            exit 1
          fi

          echo "‚úÖ Access token retrieved."
          echo "access_token=$ACCESS_TOKEN" >> $GITHUB_OUTPUT

      - name: Get latest commit SHA from repo
        id: get_commit
        run: echo "commit_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Trigger updateFromGit API
        env:
          TOKEN: ${{ steps.get_token.outputs.access_token }}
          WORKSPACE_ID: ${{ env.FABRIC_WORKSPACE_ID }}
        run: |
          set -euo pipefail

          COMMIT_SHA=${{ steps.get_commit.outputs.commit_sha }}

          echo "üöÄ Triggering updateFromGit with commit SHA: $COMMIT_SHA"

          API_URL="https://api.fabric.microsoft.com/v1/workspaces/${WORKSPACE_ID}/git/updateFromGit"

          PAYLOAD=$(jq -n \
            --arg sha "$COMMIT_SHA" \
            '{
              remoteCommitHash: $sha,
              conflictResolution: {
                conflictResolutionType: "Workspace",
                conflictResolutionPolicy: "PreferRemote"
              },
              options: {
                allowOverrideItems: true
              }
            }')

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$API_URL" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status: $HTTP_CODE"
          echo "Response Body: $BODY"

          if [[ "$HTTP_CODE" =~ ^2 ]]; then
            echo "‚úÖ updateFromGit succeeded!"
          else
            echo "‚ùå updateFromGit failed."
            exit 1
          fi
