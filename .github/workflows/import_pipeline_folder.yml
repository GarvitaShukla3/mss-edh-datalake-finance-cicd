name: Deploy Fabric Pipeline

on:
  push:
    paths:
      - 'deploy/pipeline/**'
  workflow_dispatch:

jobs:
  deploy-pipeline:
    runs-on: ubuntu-latest

    env:
      CLIENT_ID: ${{ secrets.CLIENT_ID }}
      CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
      TENANT_ID: ${{ secrets.TENANT_ID }}
      FABRIC_WORKSPACE_ID: ${{ secrets.FABRIC_WORKSPACE_ID }}

    steps:
    - uses: actions/checkout@v3

    - name: Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: 3.11

    - name: Install Fabric CLI
      run: pip install ms-fabric-cli

    - name: Login to Fabric CLI
      run: |
        fab config set encryption_fallback_enabled true
        fab auth login -u $CLIENT_ID -p $CLIENT_SECRET --tenant $TENANT_ID

    - name: Extract pipelines from ARM template
      run: |
        cat > extract_pipelines.py << 'EOF'
        import json
        import sys
        import os

        def extract_pipelines(arm_template_path, output_dir):
            with open(arm_template_path, 'r') as f:
                arm_template = json.load(f)

            resources = arm_template.get('resources', [])
            pipeline_count = 0

            if not os.path.exists(output_dir):
                os.makedirs(output_dir)

            for resource in resources:
                resource_type = resource.get('type', '').lower()
                if resource_type == 'pipelines' or resource_type.endswith('pipelines'):
                    pipeline_name = resource.get('name')
                    pipeline_properties = resource.get('properties', {})

                    if not pipeline_name or not pipeline_properties:
                        print(f"Skipping invalid pipeline resource: {resource}")
                        continue

                    # Remove unsupported fields
                    for field in ['lastModifiedByObjectId', 'lastPublishTime']:
                        pipeline_properties.pop(field, None)

                    # Construct clean manifest similar to Fabric JSON structure
                    pipeline_manifest = {
                        "name": pipeline_name,
                        "properties": pipeline_properties
                    }

                    output_path = os.path.join(output_dir, f"{pipeline_name}.json")
                    with open(output_path, 'w') as out_f:
                        json.dump(pipeline_manifest, out_f, indent=2)
                    print(f"Extracted and cleaned pipeline '{pipeline_name}' to {output_path}")
                    pipeline_count += 1

            if pipeline_count == 0:
                print("No pipelines found in ARM template.")

        if __name__ == "__main__":
            if len(sys.argv) != 3:
                print("Usage: python extract_pipelines.py <arm_template.json> <output_directory>")
                sys.exit(1)

            arm_template_path = sys.argv[1]
            output_dir = sys.argv[2]
            extract_pipelines(arm_template_path, output_dir)
        EOF

        python extract_pipelines.py deploy/pipeline/pipeline_testing/pipeline_testing.json extracted_pipelines

    - name: Print extracted pipeline file
      run: cat extracted_pipelines/pipeline_testing.json

    - name: Import pipeline(s) via Fabric CLI with detailed logs
      run: |
        mkdir -p extracted_pipelines/import_logs
        for file in extracted_pipelines/*.json; do
          pipeline_name=$(basename "$file" .json)
          echo "Importing pipeline: $pipeline_name"
          log_file="extracted_pipelines/import_logs/${pipeline_name}_import.log"
      
          # Run import and capture both stdout and stderr
          fab import Prod-Fabric-workspace.Workspace/$pipeline_name.DataPipeline --input "$file" -f > "$log_file" 2>&1 || true
      
          echo "Log for $pipeline_name:"
          cat "$log_file"
        done


    - name: Fallback:Deploy pipeline using REST API
      run: |
          echo "Falling back to REST API deployment..."

          # Get OAuth2 token using client credentials
          TOKEN=$(curl -s -X POST \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "client_id=$CLIENT_ID&client_secret=$CLIENT_SECRET&grant_type=client_credentials&scope=https%3A%2F%2Fapi.fabric.microsoft.com%2F.default" \
            "https://login.microsoftonline.com/$TENANT_ID/oauth2/v2.0/token" | jq -r .access_token)

          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "Failed to obtain access token"
            exit 1
          fi

          echo "Access token obtained. Importing pipeline..."

          # Read manifest file and send POST to Fabric API
          curl -X POST \
            "https://api.fabric.microsoft.com/v1/workspaces/$FABRIC_WORKSPACE_ID/dataPipelines" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            --data-binary @deploy/pipeline/pipeline_testing/manifest.json \
            -w "\nHTTP Status: %{http_code}\n"
