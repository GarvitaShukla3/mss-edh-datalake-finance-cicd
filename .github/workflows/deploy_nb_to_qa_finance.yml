---
name: Deploy Jupyter Notebook to QA-Finance Workspaces after Merge
on:
  push:
    branches:
      - mss-finance-edh-dev
    path:
      - deploy/notebook/**.ipynb
jobs:
  deploy_to_uat_after_merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      # - name: Azure Login
      #   env:
      #     AZURE_USERNAME: ${{ secrets. AZURE_USERNAME}}
      #     AZURE_PASSWORD: ${{ secrets. AZURE_PASSWORD }}
      #     ACTIONS_ALLOW_UNSECURE_COMMANDS: true
      #   run: >
      #     az login --username $AZURE_USERNAME --password $AZURE_PASSWORD
      #     echo "::set-env name=AZURE_ACCESS_TOKEN::$(az account get-access-token --resource 'https://api.fabric.microsoft.com' --query 'accessToken' -o tsv)" 
      #     echo "Access Token: ${{ env.AZURE_ACCESS_TOKEN }}"		
      # - name: Print Access Token
      #   run: |
      #     echo "${{ env.AZURE_ACCESS_TOKEN }}"		
      # - name: Use Access Token in Workfloww
      #   uses:
      #     AZURE_ACCESS_TOKEN: ${{ secrets. AZURE_ACCESS_TOKEN}}		
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v33
      - name: Make API Call
        env:
          # ID_TOKEN: ${{ secrets.MYID_TOKEN }}
          AZURE_ACCESS_TOKEN: ${{ secrets.AZURE_ACCESS_TOKEN }}
        run: >
          #for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          # stackfile=$(echo $file | cut -f2 -d'/')
          # parameter_value=$(cat deploy/$stackfile)
          # curl --location 'https://api.fabric.microsoft.com/v1/workspaces/1b5bf1f0-7742-49bb-a4b6-8d2720a82173/notebooks' \ 
          #   --header 'Content-Type: application/json' \
          #	--header 'Host: graph.microsoft.com' \
          #	--header "Authorization: Bearer $AZURE_ACCESS_TOKEN" \
          #   --data "$parameter_value"
          # done

          #python -m pip install --upgrade pip
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          stackfile=$(echo $file | cut -f3 -d'/')
          echo $stackfile
          parameter_value=$(cat deploy/notebook/$stackfile)
          echo "converting the python code"
          sed 's/53c6f1fd-24c3-4ab6-b9f2-a283c3bb102c/958077ec-bae1-4bda-b9a2-2116158d5879/g' deploy/notebook/$stackfile > deploy/notebook_ba 
          sed 's/654d6099-5fef-4a37-90b2-c07d16f3f88a/0fde94f2-391e-42c0-bc8c-f29f17cac5f6/g' deploy/notebook_base64_tmp_1.txt > deploy/noteb 
          python -m base64 -e deploy/notebook_base64_tmp.txt > deploy/notebook_base64_tmp1.txt
          echo "print of deploy/filename"
          cat deploy/notebook_base64_tmp1.txt
          echo "print of filename"
          python -m base64 -e deploy/notebook/$stackfile > notebook_base64.txt
          payload=$(cat deploy/notebook_base64_tmp1.txt)
          echo "payload"
          echo $payload
          #new##########
          #Pythonfile would be like below
          nbfile=$(echo $stackfile | cut -f1 -d'.')
          echo "Notebook name will be"
          echo $nbfile
          #curl --location 'https://api.fabric.microsoft.com/v1/workspaces/654d6099-5fef-4a37-90b2-c07d16f3f88a/items' \
          # --header 'Content-Type: application/json' \
          # --header "Authorization: Bearer $AZURE_ACCESS_TOKEN" \
          # --data "$parameter_value"	
          #NEW
          jq --arg val "$nbfile" '.displayName = $val' deploy/template.json > deploy/temp1.json
          jq --arg payloadValue "$payload" .definition.parts[0].payload = $payloadValue' deploy/temp1.json > deploy/final.json 
          echo "displaying temp1.json"
          echo $(cat deploy/temp1.json)
          echo "displaying Final.json"
          echo $(cat deploy/final.json)
          finaljson=$(cat deploy/final.json)
          #--data '{"displayName":"$(nbfile)","type":"Notebook","definition":{"format":"ipynb", "parts": ["path":"artifact.content.ipynb","payload":"$(payload)","payloadType":"InlineBase64"}]}}' 
          curl --location 'https://api.fabric.microsoft.com/v1/workspaces/ace17bc4-77fb-488c-8fc5-2d949f715ba5/notebooks/0598abbb-d677-4b7e-9f71-c44ece1f5c3b/updateDefinition' 
            --header 'Content-Type: application/json' \
            --header 'Host: graph.microsoft.com' \
            --header "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IkpETmFfNGk0cjdGZ2lnTDNzSElsSTN4Vi1JVSIsImtpZCI6IkpETmFfNGk0cjdGZ2lnTDNzSElsSTN4Vi1JVSJ9.eyJhdWQiOiJodHRwczovL2FwaS5mYWJyaWMubWljcm9zb2Z0LmNvbSIsImlzcyI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzU1ZWE2MTk2LTcwYjktNDQxMS05MmY1LTA0YTU0NzkxZjEyMC8iLCJpYXQiOjE3NDI1NTQ2MDQsIm5iZiI6MTc0MjU1NDYwNCwiZXhwIjoxNzQyNTYwMDc5LCJhY2N0IjowLCJhY3IiOiIxIiwiYWlvIjoiQWFRQVcvOFpBQUFBeHN6Ry9VdE9PYnJlZm9ycWh6cjRvMEF2NVNkMUFSbUwyV0ZXVXZOMVZhVkRLV2lhQ2lVcjZMb212UStnb3JSWTl6VkZGVXh4TzhmNlEveTI5aFRpNVNtT2FPL2xKdUU3NHVqTEluVDBIZ3U5eGw2Zlhrdno1M2huM1RUUXE0K2tRNitXbm1HdkNSOFdoM3VZbFU0SndobTlTVThONzBYM3BuWG1hZ0VVUCtncW9SRmpqY2pCaGRrdUtxUGRGTXc0UGhZTXhieDRLM3VKZEtxMm15RWowUT09IiwiYW1yIjpbInJzYSIsIm1mYSJdLCJhcHBpZCI6IjE4ZmJjYTE2LTIyMjQtNDVmNi04NWIwLWY3YmYyYjM5YjNmMyIsImFwcGlkYWNyIjoiMCIsImRldmljZWlkIjoiNmJiM2RmMDQtNTFlNi00MTk3LTk5NGUtOWJkMWEwMDRiODM5IiwiZmFtaWx5X25hbWUiOiJLdW1iaGFyZSIsImdpdmVuX25hbWUiOiJTYWtzaGkiLCJpZHR5cCI6InVzZXIiLCJpcGFkZHIiOiIxNjcuMTAzLjExOC4xOTUiLCJuYW1lIjoiS3VtYmhhcmUsIFNha3NoaSIsIm9pZCI6IjM5Yzk3MDc3LTMwNTEtNDUzYS05MTUyLTA2YWE0ZmFjZTIwNyIsInB1aWQiOiIxMDAzMjAwMzc5RTczMjJBIiwicmgiOiIxLkFWc0FsbUhxVmJsd0VVU1M5UVNsUjVIeElBa0FBQUFBQUFBQXdBQUFBQUFBQUFENUFEUmJBQS4iLCJzY3AiOiJBcHAuUmVhZC5BbGwgQ2FwYWNpdHkuUmVhZC5BbGwgQ2FwYWNpdHkuUmVhZFdyaXRlLkFsbCBDb25uZWN0aW9uLlJlYWQuQWxsIENvbm5lY3Rpb24uUmVhZFdyaXRlLkFsbCBDb250ZW50LkNyZWF0ZSBEYXNoYm9hcmQuUmVhZC5BbGwgRGFzaGJvYXJkLlJlYWRXcml0ZS5BbGwgRGF0YWZsb3cuUmVhZC5BbGwgRGF0YWZsb3cuUmVhZFdyaXRlLkFsbCBEYXRhc2V0LlJlYWQuQWxsIERhdGFzZXQuUmVhZFdyaXRlLkFsbCBHYXRld2F5LlJlYWQuQWxsIEdhdGV3YXkuUmVhZFdyaXRlLkFsbCBJdGVtLkV4ZWN1dGUuQWxsIEl0ZW0uRXh0ZXJuYWxEYXRhU2hhcmUuQWxsIEl0ZW0uUmVhZFdyaXRlLkFsbCBJdGVtLlJlc2hhcmUuQWxsIE9uZUxha2UuUmVhZC5BbGwgT25lTGFrZS5SZWFkV3JpdGUuQWxsIFBpcGVsaW5lLkRlcGxveSBQaXBlbGluZS5SZWFkLkFsbCBQaXBlbGluZS5SZWFkV3JpdGUuQWxsIFJlcG9ydC5SZWFkV3JpdGUuQWxsIFJlcHJ0LlJlYWQuQWxsIFN0b3JhZ2VBY2NvdW50LlJlYWQuQWxsIFN0b3JhZ2VBY2NvdW50LlJlYWRXcml0ZS5BbGwgVGVuYW50LlJlYWQuQWxsIFRlbmFudC5SZWFkV3JpdGUuQWxsIFVzZXJTdGF0ZS5SZWFkV3JpdGUuQWxsIFdvcmtzcGFjZS5HaXRDb21taXQuQWxsIFdvcmtzcGFjZS5HaXRVcGRhdGUuQWxsIFdvcmtzcGFjZS5SZWFkLkFsbCBXb3Jrc3BhY2UuUmVhZFdyaXRlLkFsbCIsInNpZCI6IjAwMjAzYTE5LTU3NTQtMWZhOS02YzhmLTczNmI1NzcyNzc3YiIsInNpZ25pbl9zdGF0ZSI6WyJpbmtub3dubnR3ayIsImttc2kiXSwic3ViIjoiRXhaVTJGdEdoRU1IUTJBcWNOOWdsYjFNYXFBZ0VVQ2tUOTNyV18yRW5zVSIsInRpZCI6IjU1ZWE2MTk2LTcwYjktNDQxMS05MmY1LTA0YTU0NzkxZjEyMCIsInVuaXF1ZV9uYW1lIjoic2Frc2hpLmt1bWJoYXJlQHN0cmF0YWNlbnQuY29tIiwidXBuIjoic2Frc2hpLmt1bWJoYXJlQHN0cmF0YWNlbnQuY29tIiwidXRpIjoiUXJtWlFhSHBPRWFya09GQUdEWlFBQSIsInZlciI6IjEuMCIsIndpZHMiOlsiYjc5ZmJmNGQtM2VmOS00Njg5LTgxNDMtNzZiMTk0ZTg1NTA5Il0sInhtc19pZHJlbCI6IjggMSIsInhtc19wbCI6ImVuLVVTIn0.Zwvkk5U4_fN5qS_dB2xCepWIjbdLYtpSH3SNB-x2UJuimS9jBwsvUGC07GPv6ht6XwSymwf0h1Pk_jqh5LJbOcp3g-k3_CVFOEl01mQbEfSiAbmmnjFibHzBw8g2-rh2xuyS3r8jbPX_oNszwuOyHSa0KabMi3I0d_dJCLlOrT9RiEnF9esTwa-fG2X2oCOQJWpkO4WLsTVgu-TajxAgLtse18XjIZLTEOQcc6iSWSGlcH-_3dwppRTioNq0IBEkBPpBm0AKm87GgpzZZlSBzHDGMY5Y9-acFMLyLZs3g0wV8Znk_TvlchUQCHF77vV0ts-XcwniNQDYNW1tjGCXzA" \
            --data "$finaljson"
          done
